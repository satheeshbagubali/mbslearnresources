<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2, h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .metric-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            text-align: center;
        }
        
        .metric-title {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .metric-change {
            font-size: 12px;
            color: var(--success);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .btn {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light);
            color: var(--dark);
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .loan-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 100;
            font-size: 12px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }
        
        .tab-btn {
            background-color: #f1f1f1;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab-btn.active {
            background-color: var(--secondary);
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border-radius: 0 5px 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .vintage-chart {
            height: 250px;
            margin-top: 20px;
        }
        
        /* New styles for loan selection */
        .loan-selection-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        
        .loan-selection-table {
            width: 100%;
        }
        
        .loan-selection-table th {
            position: sticky;
            top: 0;
            background-color: var(--light);
            z-index: 10;
        }
        
        .loan-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .success-btn {
            background-color: var(--success);
        }
        
        .warning-btn {
            background-color: var(--warning);
        }
        
        .danger-btn {
            background-color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Mortgage Analytics Dashboard</h1>
    </div>
    
    <div class="container">
        <div class="card">
            <h2>Mortgage Pool Builder</h2>
            <p>Select mortgage loans from the list below or add loans manually to analyze your mortgage pool in real-time.</p>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" id="select-tab-btn">Select Loans</button>
                    <button class="tab-btn" id="manual-tab-btn">Add Manually</button>
                </div>
                
                <div id="select-tab" class="tab-content active">
                    <h3>Available Mortgage Loans</h3>
                    
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label for="filter-vintage">Filter by Vintage:</label>
                            <select id="filter-vintage" class="form-control">
                                <option value="all">All Years</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-coupon">Filter by Coupon:</label>
                            <select id="filter-coupon" class="form-control">
                                <option value="all">All Rates</option>
                                <option value="high">High Rate (>5%)</option>
                                <option value="medium">Medium Rate (4-5%)</option>
                                <option value="low">Low Rate (<4%)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="search-loans">Search:</label>
                            <input type="text" id="search-loans" class="form-control" placeholder="Search by state, ID...">
                        </div>
                    </div>
                    
                    <div class="loan-selection-container">
                        <table class="loan-selection-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-loans" class="loan-checkbox"></th>
                                    <th>Loan ID</th>
                                    <th>Amount ($)</th>
                                    <th>Coupon (%)</th>
                                    <th>Term</th>
                                    <th>Age (months)</th>
                                    <th>Vintage</th>
                                    <th>FICO</th>
                                    <th>LTV (%)</th>
                                    <th>State</th>
                                </tr>
                            </thead>
                            <tbody id="available-loans-tbody">
                                <!-- Available loans will be populated here via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn" id="add-selected-btn">Add Selected Loans to Pool</button>
                        <button class="btn success-btn" id="add-prime-btn">Quick Add: Prime Loans</button>
                        <button class="btn warning-btn" id="add-subprime-btn">Quick Add: Subprime Loans</button>
                        <button class="btn danger-btn" id="add-jumbo-btn">Quick Add: Jumbo Loans</button>
                    </div>
                </div>
                
                <div id="manual-tab" class="tab-content">
                    <h3>Add Loan to Pool</h3>
                    <form id="add-loan-form">
                        <div class="loan-input-grid">
                            <div class="form-group">
                                <label for="loan-amount">Loan Amount ($)</label>
                                <input type="number" id="loan-amount" class="form-control" min="0" step="1000" required>
                            </div>
                            <div class="form-group">
                                <label for="loan-coupon">Coupon Rate (%)</label>
                                <input type="number" id="loan-coupon" class="form-control" min="0" max="15" step="0.125" required>
                            </div>
                            <div class="form-group">
                                <label for="loan-maturity">Original Term (months)</label>
                                <input type="number" id="loan-maturity" class="form-control" min="0" max="480" required>
                            </div>
                            <div class="form-group">
                                <label for="loan-age">Loan Age (months)</label>
                                <input type="number" id="loan-age" class="form-control" min="0" max="480" required>
                            </div>
                            <div class="form-group">
                                <label for="loan-vintage">Origination Year</label>
                                <input type="number" id="loan-vintage" class="form-control" min="1980" max="2025" required>
                            </div>
                            <div class="form-group">
                                <label for="loan-fico">FICO Score</label>
                                <input type="number" id="loan-fico" class="form-control" min="300" max="850">
                            </div>
                            <div class="form-group">
                                <label for="loan-ltv">LTV Ratio (%)</label>
                                <input type="number" id="loan-ltv" class="form-control" min="0" max="150">
                            </div>
                            <div class="form-group">
                                <label for="loan-state">Property State</label>
                                <select id="loan-state" class="form-control">
                                    <option value="">Select State</option>
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                    <option value="DC">District of Columbia</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn">Add Loan to Pool</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Weighted Average Coupon (WAC)</div>
                <div class="metric-value" id="wac-value">0.00%</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Weighted Average Maturity (WAM)</div>
                <div class="metric-value" id="wam-value">0 months</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Weighted Average Loan Age (WALA)</div>
                <div class="metric-value" id="wala-value">0 months</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Total Pool Balance</div>
                <div class="metric-value" id="total-balance">$0</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Average FICO Score</div>
                <div class="metric-value" id="avg-fico">N/A</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Average LTV Ratio</div>
                <div class="metric-value" id="avg-ltv">N/A</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="card">
                <h3>Prepayment (CPR) Projections</h3>
                <div class="chart-container">
                    <canvas id="cpr-chart"></canvas>
                </div>
                <div style="margin-top: 10px; font-size: 13px; color: #777;">
                    <p><strong>Note:</strong> CPR projections consider loan age, interest rate, FICO score, and seasonal factors.</p>
                </div>
            </div>
            <div class="card">
                <h3>Default Rate (CDR) Projections</h3>
                <div class="chart-container">
                    <canvas id="cdr-chart"></canvas>
                </div>
                <div style="margin-top: 10px; font-size: 13px; color: #777;">
                    <p><strong>Note:</strong> CDR projections consider LTV ratios, FICO scores, and loan vintage.</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>Vintage Distribution Analysis</h3>
            <div id="vintage-chart" class="vintage-chart"></div>
        </div>
        
        <div class="card">
            <h3>Stress Testing Scenarios</h3>
            <p>Apply different economic scenarios to analyze the impact on your mortgage pool.</p>
            
            <div style="margin: 15px 0; display: flex; gap: 10px;">
                <button class="btn" id="base-scenario-btn">Base Case</button>
                <button class="btn danger-btn" id="recession-scenario-btn">Recession</button>
                <button class="btn success-btn" id="recovery-scenario-btn">Recovery</button>
                <button class="btn warning-btn" id="rising-rates-scenario-btn">Rising Rates</button>
            </div>
            
            <div id="scenario-description" style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px;">
                <p><strong>Base Case Scenario:</strong> Standard economic conditions with stable interest rates and employment.</p>
            </div>
        </div>
        
        <div class="card">
            <h3>Loan Pool Details</h3>
            <table id="loan-table">
                <thead>
                    <tr>
                        <th>Loan ID</th>
                        <th>Amount ($)</th>
                        <th>Coupon (%)</th>
                        <th>Original Term</th>
                        <th>Age (months)</th>
                        <th>Vintage</th>
                        <th>FICO</th>
                        <th>LTV (%)</th>
                        <th>State</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="loan-tbody">
                    <!-- Loan data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Store mortgage pool data
        let mortgagePool = [];
        let loanCounter = 1;
        let currentScenario = 'base'; // Scenario for stress testing
        let cprChart, cdrChart; // Chart objects
        
        // Available loans database - 20 mortgage loans with different characteristics
        const availableLoans = [
            { id: 101, amount: 250000, coupon: 4.625, originalTerm: 360, age: 24, vintage: 2022, fico: 745, ltv: 75, state: 'CA' },
            { id: 102, amount: 320000, coupon: 4.125, originalTerm: 360, age: 36, vintage: 2021, fico: 780, ltv: 70, state: 'TX' },
            { id: 103, amount: 185000, coupon: 3.875, originalTerm: 360, age: 48, vintage: 2020, fico: 720, ltv: 80, state: 'FL' },
            { id: 104, amount: 420000, coupon: 3.375, originalTerm: 360, age: 60, vintage: 2019, fico: 760, ltv: 65, state: 'NY' },
            { id: 105, amount: 275000, coupon: 5.250, originalTerm: 360, age: 12, vintage: 2023, fico: 710, ltv: 82, state: 'IL' },
            { id: 106, amount: 195000, coupon: 5.500, originalTerm: 360, age: 6, vintage: 2024, fico: 690, ltv: 85, state: 'WA' },
            { id: 107, amount: 350000, coupon: 3.625, originalTerm: 360, age: 42, vintage: 2020, fico: 790, ltv: 60, state: 'CO' },
            { id: 108, amount: 225000, coupon: 4.375, originalTerm: 360, age: 30, vintage: 2021, fico: 735, ltv: 78, state: 'AZ' },
            { id: 109, amount: 555000, coupon: 3.125, originalTerm: 360, age: 54, vintage: 2019, fico: 805, ltv: 55, state: 'CA' },
            { id: 110, amount: 175000, coupon: 5.750, originalTerm: 360, age: 8, vintage: 2023, fico: 675, ltv: 90, state: 'OH' },
            { id: 111, amount: 780000, coupon: 4.000, originalTerm: 360, age: 24, vintage: 2022, fico: 770, ltv: 75, state: 'MA' },
            { id: 112, amount: 210000, coupon: 5.875, originalTerm: 360, age: 4, vintage: 2024, fico: 665, ltv: 88, state: 'MI' },
            { id: 113, amount: 495000, coupon: 3.250, originalTerm: 360, age: 48, vintage: 2020, fico: 795, ltv: 60, state: 'VA' },
            { id: 114, amount: 680000, coupon: 4.250, originalTerm: 360, age: 18, vintage: 2022, fico: 755, ltv: 72, state: 'NJ' },
            { id: 115, amount: 162000, coupon: 5.625, originalTerm: 360, age: 9, vintage: 2023, fico: 645, ltv: 92, state: 'GA' },
            { id: 116, amount: 385000, coupon: 3.750, originalTerm: 360, age: 36, vintage: 2021, fico: 765, ltv: 68, state: 'NC' },
            { id: 117, amount: 850000, coupon: 4.500, originalTerm: 360, age: 15, vintage: 2023, fico: 780, ltv: 70, state: 'CA' },
            { id: 118, amount: 142000, coupon: 6.000, originalTerm: 360, age: 3, vintage: 2024, fico: 620, ltv: 95, state: 'IN' },
            { id: 119, amount: 310000, coupon: 3.500, originalTerm: 360, age: 30, vintage: 2021, fico: 740, ltv: 75, state: 'WA' },
            { id: 120, amount: 625000, coupon: 4.875, originalTerm: 360, age: 12, vintage: 2023, fico: 730, ltv: 80, state: 'TX' }
        ];
        
        // Function to handle tab switching
        function openTab(tabName) {
            // Hide all tab content
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tab buttons
            const tabButtons = document.getElementsByClassName('tab-btn');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Show the selected tab and mark its button as active
            document.getElementById(tabName).classList.add('active');
            document.getElementById(tabName + '-btn').classList.add('active');
        }
        
        // Function to populate available loans table
        function populateAvailableLoans() {
            const tbody = document.getElementById('available-loans-tbody');
            tbody.innerHTML = '';
            
            availableLoans.forEach(loan => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="loan-checkbox" data-loan-id="${loan.id}"></td>
                    <td>${loan.id}</td>
                    <td>${loan.amount.toLocaleString('en-US')}</td>
                    <td>${loan.coupon.toFixed(3)}</td>
                    <td>${loan.originalTerm}</td>
                    <td>${loan.age}</td>
                    <td>${loan.vintage}</td>
                    <td>${loan.fico}</td>
                    <td>${loan.ltv.toFixed(1)}</td>
                    <td>${loan.state}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Filter loans based on selection criteria
        function filterLoans() {
            const vintageFilter = document.getElementById('filter-vintage').value;
            const couponFilter = document.getElementById('filter-coupon').value;
            const searchText = document.getElementById('search-loans').value.toLowerCase();
            
            const rows = document.getElementById('available-loans-tbody').querySelectorAll('tr');
            
            rows.forEach(row => {
                const loanId = row.querySelector('td:nth-child(2)').textContent;
                const loan = availableLoans.find(l => l.id == loanId);
                
                if (!loan) return;
                
                let showRow = true;
                
                // Apply vintage filter
                if (vintageFilter !== 'all') {
                    if (loan.vintage != vintageFilter) {
                        showRow = false;
                    }
                }
                
                // Apply coupon filter
                if (couponFilter !== 'all' && showRow) {
                    if (couponFilter === 'high' && loan.coupon <= 5) {
                        showRow = false;
                    } else if (couponFilter === 'medium' && (loan.coupon < 4 || loan.coupon > 5)) {
                        showRow = false;
                    } else if (couponFilter === 'low' && loan.coupon >= 4) {
                        showRow = false;
                    }
                }
                
                // Apply search filter
                if (searchText && showRow) {
                    const searchableContent = `${loan.id} ${loan.state}`.toLowerCase();
                    if (!searchableContent.includes(searchText)) {
                        showRow = false;
                    }
                }
                
                // Show or hide row
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // Toggle select all loans
        function toggleAllLoans() {
            const selectAllCheckbox = document.getElementById('select-all-loans');
            const isChecked = selectAllCheckbox.checked;
            
            const checkboxes = document.querySelectorAll('#available-loans-tbody .loan-checkbox');
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row.style.display !== 'none') { // Only toggle visible rows
                    checkbox.checked = isChecked;
                }
            });
        }
        
        // Add selected loans to the pool
        function addSelectedLoansToPool() {
            const checkboxes = document.querySelectorAll('#available-loans-tbody .loan-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one loan to add to the pool.');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const loanId = checkbox.getAttribute('data-loan-id');
                const loan = availableLoans.find(l => l.id == loanId);
                
                if (loan && !mortgagePool.some(l => l.id === loan.id)) {
                    mortgagePool.push({...loan}); // Add a copy of the loan to the pool
                }
                
                checkbox.checked = false; // Uncheck after adding
            });
            
            // Uncheck the select all checkbox
            document.getElementById('select-all-loans').checked = false;
            
            // Update the dashboard
            updateDashboard();
        }
        
        // Quick add loan categories
        function quickAddLoans(category) {
            // Clear current selection
            document.querySelectorAll('#available-loans-tbody .loan-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Select loans based on category
            switch(category) {
                case 'prime':
                    // Select loans with high FICO scores (740+) and low LTV (<80%)
                    availableLoans.forEach(loan => {
                        if (loan.fico >= 740 && loan.ltv < 80) {
                            const checkbox = document.querySelector(`#available-loans-tbody .loan-checkbox[data-loan-id="${loan.id}"]`);
                            if (checkbox) checkbox.checked = true;
                        }
                    });
                    break;
                case 'subprime':
                    // Select loans with lower FICO scores (<700) and higher LTV (>80%)
                    availableLoans.forEach(loan => {
                        if (loan.fico < 700 && loan.ltv > 80) {
                            const checkbox = document.querySelector(`#available-loans-tbody .loan-checkbox[data-loan-id="${loan.id}"]`);
                            if (checkbox) checkbox.checked = true;
                        }
                    });
                    break;
                case 'jumbo':
                    // Select loans with high balance (>500k)
                    availableLoans.forEach(loan => {
                        if (loan.amount > 500000) {
                            const checkbox = document.querySelector(`#available-loans-tbody .loan-checkbox[data-loan-id="${loan.id}"]`);
                            if (checkbox) checkbox.checked = true;
                        }
                    });
                    break;
            }
            
            // Add selected loans to pool
            addSelectedLoansToPool();
        }
        
        // Handle adding a loan manually
        function handleAddLoan(event) {
            event.preventDefault();
            
            const loan = {
                id: loanCounter++,
                amount: parseFloat(document.getElementById('loan-amount').value),
                coupon: parseFloat(document.getElementById('loan-coupon').value),
                originalTerm: parseInt(document.getElementById('loan-maturity').value),
                age: parseInt(document.getElementById('loan-age').value),
                vintage: parseInt(document.getElementById('loan-vintage').value),
                fico: parseInt(document.getElementById('loan-fico').value) || 720,
                ltv: parseFloat(document.getElementById('loan-ltv').value) || 80,
                state: document.getElementById('loan-state').value || 'CA'
            };
            
            mortgagePool.push(loan);
            
            // Reset form
            document.getElementById('add-loan-form').reset();
            
            // Update dashboard
            updateDashboard();
        }
        
        // Remove a loan from the pool
        function removeLoan(loanId) {
            mortgagePool = mortgagePool.filter(loan => loan.id !== loanId);
            updateDashboard();
        }
        
        // Update the dashboard metrics and visualizations
        function updateDashboard() {
            updatePoolTable();
            calculateMetrics();
            updateCharts();
            updateVintageChart();
        }
        
        // Update the loan pool table
        function updatePoolTable() {
            const tbody = document.getElementById('loan-tbody');
            tbody.innerHTML = '';
            
            mortgagePool.forEach(loan => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${loan.id}</td>
                    <td>${loan.amount.toLocaleString('en-US')}</td>
                    <td>${loan.coupon.toFixed(3)}</td>
                    <td>${loan.originalTerm}</td>
                    <td>${loan.age}</td>
                    <td>${loan.vintage}</td>
                    <td>${loan.fico}</td>
                    <td>${loan.ltv.toFixed(1)}</td>
                    <td>${loan.state}</td>
                    <td><button class="btn remove-loan-btn" data-loan-id="${loan.id}">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to the new remove buttons
            document.querySelectorAll('.remove-loan-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const loanId = parseInt(this.getAttribute('data-loan-id'));
                    removeLoan(loanId);
                });
            });
        }
        
        // Calculate pool metrics
        function calculateMetrics() {
            if (mortgagePool.length === 0) {
                document.getElementById('wac-value').textContent = '0.00%';
                document.getElementById('wam-value').textContent = '0 months';
                document.getElementById('wala-value').textContent = '0 months';
                document.getElementById('total-balance').textContent = '$0';
                document.getElementById('avg-fico').textContent = 'N/A';
                document.getElementById('avg-ltv').textContent = 'N/A';
                return;
            }
            
            // Calculate total balance
            const totalBalance = mortgagePool.reduce((sum, loan) => sum + loan.amount, 0);
            
            // Calculate WAC
            const wac = mortgagePool.reduce((sum, loan) => sum + (loan.amount * loan.coupon), 0) / totalBalance;
            
            // Calculate WAM
            const wam = mortgagePool.reduce((sum, loan) => sum + (loan.amount * (loan.originalTerm - loan.age)), 0) / totalBalance;
            
            // Calculate WALA
            const wala = mortgagePool.reduce((sum, loan) => sum + (loan.amount * loan.age), 0) / totalBalance;
            
            // Calculate average FICO and LTV
            const avgFico = mortgagePool.reduce((sum, loan) => sum + loan.fico, 0) / mortgagePool.length;
            const avgLtv = mortgagePool.reduce((sum, loan) => sum + loan.ltv, 0) / mortgagePool.length;
            
            // Update metrics display
            document.getElementById('wac-value').textContent = wac.toFixed(2) + '%';
            document.getElementById('wam-value').textContent = Math.round(wam) + ' months';
            document.getElementById('wala-value').textContent = Math.round(wala) + ' months';
            document.getElementById('total-balance').textContent = '$' + totalBalance.toLocaleString('en-US');
            document.getElementById('avg-fico').textContent = Math.round(avgFico);
            document.getElementById('avg-ltv').textContent = avgLtv.toFixed(1) + '%';
        }
        
        // Initialize charts
        function initializeCharts() {
            // CPR Chart
            const cprCtx = document.getElementById('cpr-chart').getContext('2d');
            cprChart = new Chart(cprCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 12}, (_, i) => `Month ${i+1}`),
                    datasets: [{
                        label: 'Projected CPR (%)',
                        data: Array(12).fill(0),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'CPR (%)'
                            }
                        }
                    }
                }
            });
            
            // CDR Chart
            const cdrCtx = document.getElementById('cdr-chart').getContext('2d');
            cdrChart = new Chart(cdrCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 12}, (_, i) => `Month ${i+1}`),
                    datasets: [{
                        label: 'Projected CDR (%)',
                        data: Array(12).fill(0),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'CDR (%)'
                            }
                        }
                    }
                }
            });
        }
        
        // Update CPR and CDR charts
        function updateCharts() {
            if (!cprChart || !cdrChart) {
                console.error("Charts not initialized");
                return;
            }
            
            if (mortgagePool.length === 0) {
                cprChart.data.datasets[0].data = Array(12).fill(0);
                cdrChart.data.datasets[0].data = Array(12).fill(0);
                cprChart.update();
                cdrChart.update();
                return;
            }
            
            // Calculate average metrics for projection models
            const avgCoupon = mortgagePool.reduce((sum, loan) => sum + loan.coupon, 0) / mortgagePool.length;
            const avgAge = mortgagePool.reduce((sum, loan) => sum + loan.age, 0) / mortgagePool.length;
            const avgFico = mortgagePool.reduce((sum, loan) => sum + loan.fico, 0) / mortgagePool.length;
            const avgLtv = mortgagePool.reduce((sum, loan) => sum + loan.ltv, 0) / mortgagePool.length;
            
            // Simplified CPR projection model
            // This is a simplified model - in practice this would use more complex models
            const cprBase = 6 + (avgCoupon * 1.2);
            const cprData = Array.from({length: 12}, (_, i) => {
                // Higher prepayments in summer months (assuming month 5-8 are summer)
                const seasonalFactor = (i >= 4 && i <= 7) ? 1.2 : 1.0;
                // Lower prepayments for newer loans, higher for seasoned loans
                const ageFactor = Math.min(1.0, avgAge / 24) * 1.5;
                // Higher FICO scores tend to prepay more
                const ficoFactor = (avgFico - 700) * 0.01;
                
                return Math.max(0, Math.min(30, (cprBase + ficoFactor) * seasonalFactor * ageFactor + (i * 0.2)));
            });
            
            // Simplified CDR projection model
            const cdrBase = 0.5 + (avgLtv - 70) * 0.05;
            const cdrData = Array.from({length: 12}, (_, i) => {
                // Higher defaults in economic stress (just a simple model)
                const stressFactor = 1.0 + (i * 0.05);
                // Lower FICO scores have higher defaults
                const ficoFactor = Math.max(0, (750 - avgFico) * 0.01);
                // Higher LTV loans have higher defaults
                const ltvFactor = Math.max(1, (avgLtv - 80) * 0.02 + 1);
                
                return Math.max(0, Math.min(5, (cdrBase + ficoFactor) * stressFactor * ltvFactor));
            });
            
            // Update charts
            cprChart.data.datasets[0].data = cprData;
            cdrChart.data.datasets[0].data = cdrData;
            
            // Apply scenario modifiers if needed
            if (currentScenario !== 'base') {
                applyScenariosToCharts(cprData, cdrData);
            } else if (cprChart.data.datasets.length > 1) {
                // Remove scenario datasets if we're in base case
                cprChart.data.datasets = [cprChart.data.datasets[0]];
                cdrChart.data.datasets = [cdrChart.data.datasets[0]];
            }
            
            cprChart.update();
            cdrChart.update();
        }
        
        // Apply different economic scenarios
        function applyScenario(scenario) {
            currentScenario = scenario;
            
            // Update scenario description
            const description = document.getElementById('scenario-description');
            
            switch(scenario) {
                case 'base':
                    description.innerHTML = '<p><strong>Base Case Scenario:</strong> Standard economic conditions with stable interest rates and employment.</p>';
                    break;
                case 'recession':
                    description.innerHTML = '<p><strong>Recession Scenario:</strong> Economic downturn with rising unemployment, decreased housing prices, and stressed borrowers.</p>';
                    break;
                case 'recovery':
                    description.innerHTML = '<p><strong>Recovery Scenario:</strong> Economic growth with declining unemployment, increasing home values, and improved borrower credit.</p>';
                    break;
                case 'rising-rates':
                    description.innerHTML = '<p><strong>Rising Rates Scenario:</strong> Increasing interest rates leading to reduced refinancing activity and potential payment stress.</p>';
                    break;
            }
            
            // Update charts for the new scenario
            updateCharts();
        }
        
        // Get color for scenario charts
        function getScenarioColor(alpha = 1) {
            const colors = {
                'recession': `rgba(231, 76, 60, ${alpha})`,
                'recovery': `rgba(46, 204, 113, ${alpha})`,
                'rising-rates': `rgba(243, 156, 18, ${alpha})`
            };
            
            return colors[currentScenario] || `rgba(52, 152, 219, ${alpha})`;
        }
        
        // Apply scenario modifiers to CPR and CDR data
        function applyScenariosToCharts(baseCprData, baseCdrData) {
            const scenarioModifiers = {
                'recession': {
                    cpr: baseCprData.map(value => value * 0.7), // Lower prepayments in recession
                    cdr: baseCdrData.map(value => value * 2.5)  // Higher defaults in recession
                },
                'recovery': {
                    cpr: baseCprData.map(value => value * 1.3), // Higher prepayments in recovery
                    cdr: baseCdrData.map(value => value * 0.6)  // Lower defaults in recovery
                },
                'rising-rates': {
                    cpr: baseCprData.map(value => value * 0.5), // Much lower prepayments when rates rise
                    cdr: baseCdrData.map(value => value * 1.2)  // Slightly higher defaults with rising rates
                }
            };
            
            if (scenarioModifiers[currentScenario]) {
                // Add scenario data as a new dataset
                if (cprChart.data.datasets.length > 1) {
                    cprChart.data.datasets[1].data = scenarioModifiers[currentScenario].cpr;
                    cdrChart.data.datasets[1].data = scenarioModifiers[currentScenario].cdr;
                } else {
                    // Add new dataset for scenario
                    cprChart.data.datasets.push({
                        label: 'Scenario CPR (%)',
                        data: scenarioModifiers[currentScenario].cpr,
                        borderColor: getScenarioColor(),
                        backgroundColor: getScenarioColor(0.1),
                        tension: 0.3,
                        fill: true
                    });
                    
                    cdrChart.data.datasets.push({
                        label: 'Scenario CDR (%)',
                        data: scenarioModifiers[currentScenario].cdr,
                        borderColor: getScenarioColor(),
                        backgroundColor: getScenarioColor(0.1),
                        tension: 0.3,
                        fill: true
                    });
                }
            }
        }
        
        // Update Vintage Chart using D3.js
        function updateVintageChart() {
            const vintageDiv = document.getElementById('vintage-chart');
            vintageDiv.innerHTML = '';
            
            if (mortgagePool.length === 0) {
                return;
            }
            
            // Group loans by vintage
            const vintageGroups = {};
            mortgagePool.forEach(loan => {
                if (!vintageGroups[loan.vintage]) {
                    vintageGroups[loan.vintage] = 0;
                }
                vintageGroups[loan.vintage] += loan.amount;
            });
            
            // Convert to array and sort by vintage
            const vintageData = Object.entries(vintageGroups).map(([vintage, amount]) => ({
                vintage: parseInt(vintage),
                amount
            })).sort((a, b) => a.vintage - b.vintage);
            
            // D3 visualization
            const margin = {top: 20, right: 20, bottom: 30, left: 80};
            const width = vintageDiv.clientWidth - margin.left - margin.right;
            const height = vintageDiv.clientHeight - margin.top - margin.bottom;
            
            const svg = d3.select('#vintage-chart')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
                
            // X axis
            const x = d3.scaleBand()
                .range([0, width])
                .domain(vintageData.map(d => d.vintage))
                .padding(0.2);
                
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .style('text-anchor', 'end')
                .attr('dx', '-.8em')
                .attr('dy', '.15em')
                .attr('transform', 'rotate(-45)');
                
            // Y axis
            const y = d3.scaleLinear()
                .domain([0, d3.max(vintageData, d => d.amount) * 1.1])
                .range([height, 0]);
                
            svg.append('g')
                .call(d3.axisLeft(y).tickFormat(d => '$' + d3.format(',.0f')(d)));
                
            // Tooltip
            const tooltip = d3.select('#vintage-chart')
                .append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);
                
            // Bars
            svg.selectAll('bar')
                .data(vintageData)
                .enter()
                .append('rect')
                .attr('x', d => x(d.vintage))
                .attr('width', x.bandwidth())
                .attr('fill', '#3498db')
                .attr('height', d => height - y(0))
                .attr('y', d => y(0))
                .on('mouseover', function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    tooltip.html(`Vintage: ${d.vintage}<br>Amount: $${d.amount.toLocaleString('en-US')}`)
                        .style('left', (event.pageX + 5) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function() {
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                });
                
            // Animation
            svg.selectAll('rect')
                .transition()
                .duration(800)
                .attr('y', d => y(d.amount))
                .attr('height', d => height - y(d.amount))
                .delay((d,i) => i*100);
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Tab switching
            document.getElementById('select-tab-btn').addEventListener('click', () => openTab('select-tab'));
            document.getElementById('manual-tab-btn').addEventListener('click', () => openTab('manual-tab'));
            
            // Filter controls
            document.getElementById('filter-vintage').addEventListener('change', filterLoans);
            document.getElementById('filter-coupon').addEventListener('change', filterLoans);
            document.getElementById('search-loans').addEventListener('input', filterLoans);
            
            // Select all checkbox
            document.getElementById('select-all-loans').addEventListener('change', toggleAllLoans);
            
            // Add selected loans button
            document.getElementById('add-selected-btn').addEventListener('click', addSelectedLoansToPool);
            
            // Quick add buttons
            document.getElementById('add-prime-btn').addEventListener('click', () => quickAddLoans('prime'));
            document.getElementById('add-subprime-btn').addEventListener('click', () => quickAddLoans('subprime'));
            document.getElementById('add-jumbo-btn').addEventListener('click', () => quickAddLoans('jumbo'));
            
            // Manual loan form
            document.getElementById('add-loan-form').addEventListener('submit', handleAddLoan);
            
            // Scenario buttons
            document.getElementById('base-scenario-btn').addEventListener('click', () => applyScenario('base'));
            document.getElementById('recession-scenario-btn').addEventListener('click', () => applyScenario('recession'));
            document.getElementById('recovery-scenario-btn').addEventListener('click', () => applyScenario('recovery'));
            document.getElementById('rising-rates-scenario-btn').addEventListener('click', () => applyScenario('rising-rates'));
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            initializeCharts();
            
            // Populate available loans table
            populateAvailableLoans();
            
            // Set up all event listeners
            setupEventListeners();
        });
    </script>
</body>
</html>